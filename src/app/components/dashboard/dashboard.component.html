<div class="dashboard-container">

  <div class="stats-grid">
    <div class="card">
      <div class="card-content">
        <div>
          <p>Temperatura</p>
          <h3>{{ this.weatherService.weatherData ? this.weatherService.weatherData.daily[0].temp.day : '--' }} °C</h3>
          <small>Umidade: {{ this.weatherService.weatherData ? this.weatherService.weatherData.daily[0].humidity : '--'
            }}%</small>
        </div>
        <div class="icon-wrapper bg-yellow">
          <mat-icon>thermostat</mat-icon>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-content">
        <div>
          <p>Consumo de Água</p>
          <h3>{{ totalSavings.toFixed(2) }} L</h3>
          <small class="text-green">economia total</small>
        </div>
        <div class="icon-wrapper bg-blue">
          <mat-icon>water_drop</mat-icon>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-content">
        <div>
          <p>Sensores Ativos</p>
          <h3>{{ sensorData.length }}</h3>
          <small *ngIf="drawnArea" class="text-green">
            {{ sensorsInAreaCount }} na área selecionada
          </small>
          <small *ngIf="!drawnArea" class="text-green">operando</small>
        </div>
        <div class="icon-wrapper bg-purple">
          <mat-icon>wifi</mat-icon>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-content">
        <div>
          <p>Alertas</p>
          <h3>{{ (this.weatherService.weatherData?.alerts) ? '1' : '0' }}</h3>
          <small>{{ (this.weatherService.weatherData?.alerts) ? weatherService.weatherData.alerts[0].event : 'Nenhum
            alerta' }}</small>
        </div>
        <div class="icon-wrapper bg-red">
          <mat-icon>warning</mat-icon>
        </div>
      </div>
    </div>
  </div>

  <div class="data-grid">
    <div class="card data-card span-col-2">
      <h3>Monitoramento de Umidade dos Sensores</h3>
      <div class="chart-container">
        <canvas id="sensorLineChart"></canvas>
      </div>
    </div>
    <div class="card data-card">
      <h3>Previsão da Semana</h3>
      <div id="prev-container" class="forecast-container"></div>
    </div>
  </div>

  <div class="full-width-section">
    <div class="card data-card">
      <h3>Mapa e Localização</h3>
      <div class="search-bar">
        <input type="text" [(ngModel)]="searchQuery" placeholder="Buscar endereço...">
        <button (click)="searchAddress()">Buscar</button>
      </div>
      <div id="map"></div>
      <b>{{ this.weatherService.location.address }}</b>
    </div>
  </div>

  <div class="full-width-section">
    <div class="card data-card">
      <div class="card-header">
        <div>
          <h3>Controle de Irrigação</h3>
          <p class="card-subtitle">Recomendações de irrigação e cálculo hídrico</p>
        </div>
        <div class="header-actions">
          <button class="calculate-btn-header" mat-raised-button color="primary" (click)="calculateIrrigation()">
            <mat-icon>calculate</mat-icon>
            Calcular
          </button>
          <button class="info-btn" mat-icon-button matTooltip="Cálculos baseados em Penman-Monteith">
            <mat-icon>info</mat-icon>
          </button>
        </div>
      </div>

      <div class="irrigation-summary" *ngIf="irrigationResults">
        <div class="summary-item">
          <div class="summary-icon">
            <mat-icon>water_drop</mat-icon>
          </div>
          <div class="summary-content">
            <span class="summary-label">Irrigação Total</span>
            <span class="summary-value">{{ getTotalIrrigation() }} mm</span>
          </div>
        </div>
        <div class="summary-item">
          <div class="summary-icon">
            <mat-icon>calendar_today</mat-icon>
          </div>
          <div class="summary-content">
            <span class="summary-label">Dias Analisados</span>
            <span class="summary-value">{{ irrigationService.irrigationData.data.length }} dias</span>
          </div>
        </div>
        <div class="summary-item">
          <div class="summary-icon bg-green">
            <mat-icon>savings</mat-icon>
          </div>
          <div class="summary-content">
            <span class="summary-label">Economia Estimada</span>
            <span class="summary-value">{{ totalSavings.toFixed(1) }} mm</span>
          </div>
        </div>
      </div>

      <div *ngIf="irrigationResults" class="irrigation-cards-grid">
        <div class="irrigation-card" *ngFor="let result of irrigationService.irrigationData.data; let i = index"
          [class.high-irrigation]="result.finalIrrigation > 10"
          [class.medium-irrigation]="result.finalIrrigation > 5 && result.finalIrrigation <= 10"
          [class.low-irrigation]="result.finalIrrigation <= 5">

          <div class="card-header-mini">
            <span class="day-name">{{ getDayName(filteredWeatherData[i].date) }}</span>
            <span class="day-date">{{ getFormattedDate(filteredWeatherData[i].date) }}</span>
          </div>

          <div class="card-body-mini">
            <div class="irrigation-value-group">
              <mat-icon>opacity</mat-icon>
              <span class="main-value">{{ result.finalIrrigation }} mm</span>
            </div>

            <div class="weather-mini-details">
              <small><mat-icon>umbrella</mat-icon> {{ result.effectiveRain }} mm</small>
              <small *ngIf="filteredWeatherData[i]"><mat-icon>thermostat</mat-icon> {{ filteredWeatherData[i].temp
                }}°C</small>
            </div>
          </div>

          <div class="status-strip" [class]="getIrrigationStatus(result.finalIrrigation)">
            {{ getIrrigationStatusText(result.finalIrrigation) }}
          </div>
        </div>
      </div>

      <div class="no-data" *ngIf="!irrigationResults">
        <mat-icon>water_drop</mat-icon>
        <p>Nenhum cálculo de irrigação disponível</p>
        <small>Clique em "Calcular" para gerar as recomendações.</small>
      </div>

    </div>
  </div>

</div>